reference: https://www.metagenomics.wiki/tools/short-read/remove-host-sequences

Using bowtie2 together with samtools
complex solution that gives better control over the rejected reads by using SAM-flags

How to filter out host reads from paired-end fastq files?

a) bowtie2 mapping against host genome: write all (mapped and unmapped) reads to a single .bam file

b) samtools view: use filter-flags to extract unmapped reads

c) samtools fastq: split paired-end reads into separated R1 and R2 fastq files

a) bowtie2 mapping against host sequence
  1) create or download ready to use bowtie2 index databases (host_DB)

   # create bowtie2 database using a reference genome (fasta file)

  bowtie2-build host_genome_sequence.fasta host_DB


  2) bowtie2 mapping against host sequence database, keep both aligned and unaligned reads (paired-end reads)

  bowtie2 -p 8 -x host_DB \

    -1 SAMPLE_R1.fastq.gz \

    -2 SAMPLE_R2.fastq.gz \

    -S SAMPLE_mapped_and_unmapped.sam

  3) convert file .sam to .bam

   samtools view -bS SAMPLE_mapped_and_unmapped.sam > SAMPLE_mapped_and_unmapped.bam

b) filter required unmapped reads
# SAMtools SAM-flag filter: get unmapped pairs (both reads R1 and R2 unmapped)

 samtools view -b -f 12 -F 256 \

   SAMPLE_mapped_and_unmapped.bam \

   > SAMPLE_bothReadsUnmapped.bam 

    -f  12    # Extract only ( -f ) alignments with both reads unmapped: <read unmapped><mate unmapped>

    -F 256    # Do not (  -F  ) extract alignments which are: <not primary alignment>

see meaning of SAM-flags

c)  split paired-end reads into separated fastq files .._R1 .._R2
# sort bam file by read name ( -n ) to have paired reads next to each other (2 parallel threads, each using up to 5G memory)

samtools sort -n -m 5G -@ 2 SAMPLE_bothReadsUnmapped.bam -o SAMPLE_bothReadsUnmapped_sorted.bam

samtools fastq -@ 8 SAMPLE_bothReadsUnmapped_sorted.bam \

  -1 SAMPLE_host_removed_R1.fastq.gz \

  -2 SAMPLE_host_removed_R2.fastq.gz \

  -0 /dev/null -s /dev/null -n

http://www.htslib.org/doc/samtools-fasta.html

see other options for  â†’ converting .bam to .fastq

Result
Two files of paired-end reads, containing non-host sequences

SAMPLE_host_removed_R1.fastq.gz

SAMPLE_host_removed_R2.fastq.gz

